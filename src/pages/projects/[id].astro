---
import { getCollection, render } from "astro:content";
import Layout from "@/layouts/Layout.astro";
import BackArrow from "@/components/BackArrow";
import ProjectCarousel from "@/components/project/ProjectCarousel";
import Tag from "@/components/SmallTag";
import Prose from "@/components/Prose.astro";
import { Image } from "astro:assets";
import { getImage } from "@/utils/imageMap";

export async function getStaticPaths() {
  const projects = await getCollection("projects");
  return projects.map((post) => ({
    params: { id: post.data.id },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content } = await render(post);
const project = post.data;
const projectImage = getImage(project.image_links[0]);
---

<Layout>
  <div class="px-4 py-6 sm:px-6 md:px-8 lg:px-12">
    <BackArrow client:load />
    <div class="relative mb-8">
      <div
        class="absolute inset-0 w-full aspect-[16/9] max-h-[500px] overflow-hidden bg-black rounded-md z-10 transition-opacity duration-500 flex justify-center items-center p-3"
        id="transition-static-image"
      >
        <Image
          class="h-full w-fit object-contain"
          src={projectImage}
          alt={project.title}
          width={800}
          height={450}
          quality={90}
          format="webp"
          transition:name={`${project.id}-image`}
        />
      </div>
      <ProjectCarousel
        images={project.image_links}
        captions={project.image_captions}
        client:load
      />
    </div>
    <script>
      document.addEventListener('astro:after-swap', () => {
        // Wait for transition to complete before fading out static image
        const staticImage = document.getElementById('transition-static-image');
        if (staticImage) {
          setTimeout(() => {
            staticImage.style.opacity = '0';
            setTimeout(() => {
              staticImage.remove();
            }, 500);
          }, 200);
        }
      });
    </script>
    <div class="max-w-[850px] mx-auto">
      <div class="flex flex-col mb-6 mt-2">
        <h3
          class="font-semibold text-4xl grow mb-1"
          transition:name={`${project.id}-title`}
        >
          {project.title}
        </h3>
        <h2 class="text-neutral-400 text-lg" transition:name={`${project.id}-date`}>{project.date_range}</h2>
      </div>
      <div
        class="flex flex-col sm:flex-row-reverse gap-4 mb-8 text-neutral-200"
      >
        {
          project.tags && project.tags.length > 0 && (
            <div class="rounded-lg p-4 font-semibold w-fit outline outline-1 outline-neutral-600 bg-neutral-900/30">
              <span class="font-semibold text-xl text-neutral-200 block mb-3">
                Technologies
              </span>
              <div class="flex gap-1 mt-2 flex-wrap" transition:name={`${project.id}-tags`}>
                {project.tags.map((tag) => (
                  <Tag text={tag} />
                ))}
              </div>
            </div>
          )
        }
        <div class="grow">
          <span class="font-semibold text-xl block mb-2">Description</span>
          <p
            class="text-neutral-300 text-base leading-relaxed"
            set:html={project.description}
            transition:name={`${project.id}-description`}
          />
        </div>
      </div>
      <Prose>
        <Content />
      </Prose>
    </div>
  </div>
</Layout>
